<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Сатурн – Three.js + MindAR</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
      font-family: 'Inter', sans-serif; /* Використання шрифту Inter */
      background-color: #000; /* Темний фон для космічної теми */
    }
    #ar-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #message-box {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(255, 255, 255, 0.9);
        color: #333;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        text-align: center;
        max-width: 80%;
        font-family: 'Inter', sans-serif;
    }
    .css3d-element {
        padding: 8px 12px;
        background: rgba(0,0,0,0.6);
        color: #fff;
        border-radius: 8px;
        font-size: 1.2em;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    /* Стилі для кнопки "Got It!" */
    #message-box button {
        margin-top: 15px;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        transition: background-color 0.3s ease;
    }
    #message-box button:hover {
        background-color: #0056b3;
    }
  </style>

  <!-- Карта імпорту для "bare-specifier’ів" -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js",
      "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/",
      "mind-ar/image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-three.prod.js"
    }
  }
  </script>
</head>
<body>
  <!-- Тут MindAR відмалює відеопотік + WebGL -->
  <div id="ar-container"></div>

  <!-- Повідомлення про обмеження функціоналу AR -->
  <div id="message-box" style="display: none;">
      <h2>Функціонал AR обмежений</h2>
      <p>Функції доповненої реальності (AR) цього додатка вимагають спеціального файлу <strong>targets.mind</strong>, який недоступний у цьому середовищі.</p>
      <p>Замість AR-досвіду ви побачите 3D-модель Сатурна, що обертається, із заповнювачами текстур.</p>
      <button onclick="document.getElementById('message-box').style.display = 'none'; this.remove();">
          Зрозуміло!
      </button>
  </div>

  <script type="module">
    // 2) Імпорти тепер працюють без помилок завдяки карті імпорту
    import * as THREE from 'three';
    // Імпорт CSS3DRenderer, який тепер має бути правильно зіставлений через importmap
    import { CSS3DRenderer, CSS3DObject } from 'three/examples/jsm/renderers/CSS3DRenderer.js';
    import { MindARThree } from 'mind-ar/image-three';

    async function startAR() {
      // Показати вікно повідомлення про обмеження AR
      document.getElementById('message-box').style.display = 'block';

      // WebGL-рендерер для 3D-сцени
      const webGLRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      webGLRenderer.setSize(window.innerWidth, window.innerHeight);
      webGLRenderer.xr.enabled = false; // WebXR не потрібен для AR
      webGLRenderer.shadowMap.enabled = true; // Увімкнути тіні
      document.querySelector('#ar-container').appendChild(webGLRenderer.domElement);

      // (Опційно) CSS3D-рендерер для HTML-об'єктів у 3D
      const cssRenderer = new CSS3DRenderer();
      cssRenderer.setSize(window.innerWidth, window.innerHeight);
      cssRenderer.domElement.style.position = 'absolute';
      cssRenderer.domElement.style.top = '0';
      cssRenderer.domElement.style.pointerEvents = 'none'; // Дозволити клікам проходити крізь елемент
      document.body.appendChild(cssRenderer.domElement);

      // Налаштування сцени MindAR
      const mindar = new MindARThree({
        container: document.querySelector('#ar-container'),
        // ВАЖЛИВО: 'imageTargetSrc' закоментовано, оскільки файл 'targets.mind'
        // необхідний для функціонування MindAR як додатка доповненої реальності,
        // і він недоступний у цьому середовищі.
        // Для функціоналу AR вам потрібно буде надати власний файл 'targets.mind'.
        // imageTargetSrc: '/assets/targets.mind',
        uiScanning: true, // Показати інтерфейс сканування
        uiLoading: 'Завантажуємо…' // Показати повідомлення про завантаження
      });
      const { scene, camera } = mindar;

      // Світла
      scene.add(new THREE.AmbientLight(0xffffff, 0.2)); // М'яке навколишнє світло
      const point = new THREE.PointLight(0xffffff, 1, 50); // Точкове джерело світла
      point.castShadow = true; // Увімкнути тіні від цього світла
      point.position.set(0, 5, 5); // Розташувати світло
      scene.add(point);

      // Прив'язуємо контент до першого якоря (MindAR створює якір за замовчуванням навіть без цілі)
      // Якорі MindAR дозволяють розташовувати 3D-об'єкти відносно виявлених AR-маркерів.
      const anchor = mindar.addAnchor(0);
      const saturnGroup = new THREE.Group(); // Група для Сатурна та його кілець
      anchor.group.add(saturnGroup);

      // Завантажуємо текстури, використовуючи заповнювачі, оскільки локальні ресурси недоступні
      const loader = new THREE.TextureLoader();
      const texSat = loader.load('https://placehold.co/512x512/d6ab73/333333?text=Saturn'); // Заповнювач для текстури Сатурна
      const texRing = loader.load('https://placehold.co/512x512/e6d79a/333333?text=Rings'); // Заповнювач для текстури Кілець

      // Сфера Сатурна
      const sphere = new THREE.Mesh(
        new THREE.SphereGeometry(2, 64, 64), // Радіус 2, 64 сегменти по ширині/висоті для гладкої сфери
        new THREE.MeshStandardMaterial({ map: texSat, metalness: 0.2, roughness: 0.9 })
      );
      sphere.castShadow = true; // Сфера відкидає тіні
      saturnGroup.add(sphere);

      // Кільце
      const ring = new THREE.Mesh(
        new THREE.RingGeometry(2.5, 4.5, 256), // Внутрішній радіус 2.5, зовнішній радіус 4.5, 256 сегментів для гладкого кільця
        new THREE.MeshStandardMaterial({
          map: texRing,
          side: THREE.DoubleSide, // Рендерити обидві сторони кільця
          transparent: true,      // Увімкнути прозорість
          alphaTest: 0.5          // Пікселі з альфа менше 0.5 відкидаються (для прозорості текстури)
        })
      );
      ring.rotation.x = -Math.PI / 2; // Обернути кільце горизонтально
      ring.castShadow = true; // Кільце відкидає тіні
      saturnGroup.add(ring);

      // (Опційно) Приклад CSS3D-елемента
      const el = document.createElement('div');
      el.innerText = 'Привіт з CSS3D';
      el.className = 'css3d-element'; // Застосувати стилі з CSS
      const cssObj = new CSS3DObject(el);
      cssObj.position.set(0, 3, 0); // Розташувати відносно saturnGroup
      saturnGroup.add(cssObj);

      // Підлаштування під розмір вікна для адаптивності
      window.addEventListener('resize', () => {
        webGLRenderer.setSize(window.innerWidth, window.innerHeight);
        cssRenderer.setSize(window.innerWidth, window.innerHeight);
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
      });

      // Старт AR та рендер-цикл
      try {
        await mindar.start(); // Спроба запустити MindAR
      } catch (error) {
        console.error("MindAR не вдалося запустити. Функції AR не будуть активними:", error);
        // Fallback: якщо MindAR не вдається запустити, переконайтеся, що камера налаштована для базового 3D-перегляду.
        // Наразі MindAR все ще ініціалізує камеру та сцену навіть без дійсної цілі.
      }

      webGLRenderer.setAnimationLoop(() => {
        // Анімувати обертання групи Сатурна
        saturnGroup.rotation.y += 0.005;

        // Рендерити як WebGL, так і CSS3D сцени
        webGLRenderer.render(scene, camera);
        cssRenderer.render(scene, camera);
      });
    }

    // Переконайтеся, що AR-досвід починається після повного завантаження вікна
    window.onload = function () {
        startAR();
    };
  </script>
</body>
</html>
