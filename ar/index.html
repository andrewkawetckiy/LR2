<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Сатурн – Three.js + MindAR</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
      font-family: 'Inter', sans-serif; /* Використання шрифту Inter */
      background-color: #000; /* Темний фон для космічної теми */
    }
    #ar-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #message-box { /* Стилі для вікна повідомлень */
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(255, 255, 255, 0.9);
        color: #333;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        text-align: center;
        max-width: 80%;
        font-family: 'Inter', sans-serif;
    }
    .css3d-element {
        padding: 8px 12px;
        background: rgba(0,0,0,0.6);
        color: #fff;
        border-radius: 8px;
        font-size: 1.2em;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    /* Стилі для кнопки в повідомленні */
    #message-box button {
        margin-top: 15px;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        transition: background-color 0.3s ease;
    }
    #message-box button:hover {
        background-color: #0056b3;
    }
  </style>

  <!-- Карта імпорту для "bare-specifier’ів" -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js",
      "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/",
      "mind-ar/image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-three.prod.js"
    }
  }
  </script>
</head>
<body>
  <!-- Тут MindAR відмалює відеопотік + WebGL -->
  <div id="ar-container"></div>

  <!-- Вікно для повідомлень про статус AR або помилки -->
  <div id="message-box" style="display: none;">
      <h2 id="message-title"></h2>
      <p id="message-content"></p>
      <button id="message-button">Зрозуміло!</button>
  </div>

  <script type="module">
    // Імпорти працюють без помилок завдяки карті імпорту
    import * as THREE from 'three';
    import { CSS3DRenderer, CSS3DObject } from 'three/examples/jsm/renderers/CSS3DRenderer.js';
    import { MindARThree } from 'mind-ar/image-three';

    // Функція для відображення повідомлень користувачеві
    function showMessage(title, content) {
        const messageBox = document.getElementById('message-box');
        const messageTitle = document.getElementById('message-title');
        const messageContent = document.getElementById('message-content');
        const messageButton = document.getElementById('message-button');

        messageTitle.innerText = title;
        messageContent.innerHTML = content;
        messageBox.style.display = 'block';

        messageButton.onclick = () => {
            messageBox.style.display = 'none';
        };
    }

    async function startAR() {
      // Приховати вікно повідомлення, якщо воно з'явилося раніше
      document.getElementById('message-box').style.display = 'none';

      // **Попередня перевірка та запит доступу до камери**
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showMessage(
            "Помилка камери:",
            "Ваш браузер або середовище не підтримує доступ до камери, що є необхідним для AR. <br>Будь ласка, переконайтеся, що ви використовуєте сучасний браузер і що він підтримує API WebRTC."
        );
        return; // Вийти з функції startAR
      }

      try {
          // Спробуємо отримати доступ до камери перед ініціалізацією MindAR
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          // Якщо потік отримано, негайно зупиняємо його, оскільки MindAR сам керуватиме потоком.
          stream.getTracks().forEach(track => track.stop());
      } catch (e) {
          console.error("Помилка доступу до камери:", e);
          let cameraErrorMessage = "Не вдалося отримати доступ до камери. ";

          if (e instanceof DOMException) {
              if (e.name === "NotReadableError") {
                  cameraErrorMessage += "Причина: Камера зайнята або недоступна. <br>Будь ласка, переконайтеся, що жодна інша програма не використовує камеру, та надайте дозволи.";
              } else if (e.name === "NotAllowedError") {
                  cameraErrorMessage += "Причина: Доступ до камери заборонено користувачем або платформою. <br>Будь ласка, дозвольте доступ до камери для цього сайту в налаштуваннях вашого браузера. Це може бути пов'язано з тим, що ви використовуєте HTTP замість HTTPS, або доступ заблоковано системою.";
              } else if (e.name === "OverconstrainedError") {
                  cameraErrorMessage += "Причина: Не вдалося отримати медіа-потік згідно з вимогами. <br>Можливо, конфлікт з іншим додатком, який використовує камеру, або проблема з вибраними параметрами камери.";
              } else {
                  cameraErrorMessage += `Невідома помилка DOMException: ${e.name}: ${e.message}.`;
              }
          } else {
              cameraErrorMessage += `Невідома помилка: ${e.message || e}.`;
          }
          showMessage(
              "Помилка AR:",
              cameraErrorMessage + "<br>Ви все одно побачите 3D-модель Сатурна, що обертається."
          );
          return; // Вийти, якщо доступ до камери не отримано
      }

      // WebGL-рендерер для 3D-сцени
      const webGLRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      webGLRenderer.setSize(window.innerWidth, window.innerHeight);
      webGLRenderer.xr.enabled = false; // WebXR не потрібен для AR
      webGLRenderer.shadowMap.enabled = true; // Увімкнути тіні
      document.querySelector('#ar-container').appendChild(webGLRenderer.domElement);

      // (Опційно) CSS3D-рендерер для HTML-об'єктів у 3D
      const cssRenderer = new CSS3DRenderer();
      cssRenderer.setSize(window.innerWidth, window.innerHeight);
      cssRenderer.domElement.style.position = 'absolute';
      cssRenderer.domElement.style.top = '0';
      cssRenderer.domElement.style.pointerEvents = 'none'; // Дозволити клікам проходити крізь елемент
      document.body.appendChild(cssRenderer.domElement);

      // Налаштування сцени MindAR
      const mindar = new MindARThree({
        container: document.querySelector('#ar-container'),
        imageTargetSrc: 'assets/targets/targets.mind', // Шлях до файлу targets.mind
        uiScanning: true, // Показати інтерфейс сканування
        uiLoading: 'Завантажуємо…' // Показати повідомлення про завантаження
      });
      const { scene, camera } = mindar;

      // Світла
      scene.add(new THREE.AmbientLight(0xffffff, 0.2)); // М'яке навколишнє світло
      const point = new THREE.PointLight(0xffffff, 1, 50); // Точкове джерело світла
      point.castShadow = true; // Увімкнути тіні від цього світла
      point.position.set(0, 5, 5); // Розташувати світло
      scene.add(point);

      // Прив'язуємо контент до першого якоря
      const anchor = mindar.addAnchor(0);
      const saturnGroup = new THREE.Group(); // Група для Сатурна та його кілець
      anchor.group.add(saturnGroup);

      // Завантажуємо текстури з вказаних вами шляхів
      const loader = new THREE.TextureLoader();
      const texSat = loader.load('assets/textures/saturn.jpg'); // Шлях до текстури Сатурна
      const texRing = loader.load('assets/textures/rings.jpg'); // Шлях до текстури Кілець

      // Сфера Сатурна
      const sphere = new THREE.Mesh(
        new THREE.SphereGeometry(2, 64, 64), // Радіус 2, 64 сегменти по ширині/висоті для гладкої сфери
        new THREE.MeshStandardMaterial({ map: texSat, metalness: 0.2, roughness: 0.9 })
      );
      sphere.castShadow = true; // Сфера відкидає тіні
      saturnGroup.add(sphere);

      // Кільце
      const ring = new THREE.Mesh(
        new THREE.RingGeometry(2.5, 4.5, 256), // Внутрішній радіус 2.5, зовнішній радіус 4.5, 256 сегментів для гладкого кільця
        new THREE.MeshStandardMaterial({
          map: texRing,
          side: THREE.DoubleSide, // Рендерити обидві сторони кільця
          transparent: true,      // Увімкнути прозорість
          alphaTest: 0.5          // Пікселі з альфа менше 0.5 відкидаються (для прозорості текстури)
        })
      );
      ring.rotation.x = -Math.PI / 2; // Обернути кільце горизонтально
      ring.castShadow = true; // Кільце відкидає тіні
      saturnGroup.add(ring);

      // (Опційно) Приклад CSS3D-елемента
      const el = document.createElement('div');
      el.innerText = 'Привіт з CSS3D';
      el.className = 'css3d-element'; // Застосувати стилі з CSS
      const cssObj = new CSS3DObject(el);
      cssObj.position.set(0, 3, 0); // Розташувати відносно saturnGroup
      saturnGroup.add(cssObj);

      // Підлаштування під розмір вікна для адаптивності
      window.addEventListener('resize', () => {
        webGLRenderer.setSize(window.innerWidth, window.innerHeight);
        cssRenderer.setSize(window.innerWidth, window.innerHeight);
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
      });

      // Старт AR та рендер-цикл
      try {
        await mindar.start(); // Спроба запустити MindAR
      } catch (error) {
        console.error("MindAR failed to start. AR functions will not be active:", error);

        let errorMessage = "Функції доповненої реальності не вдалося запустити.";

        if (error && error.message && error.message.includes("targets.mind")) {
            errorMessage += " <br>Причина: Не вдалося завантажити файл цілей AR. Перевірте шлях 'assets/targets/targets.mind' та переконайтеся, що файл існує.";
        } else if (error) {
            errorMessage += ` <br>Невідома помилка: ${error.message || error}.`;
        } else {
            // Це для випадку, коли "error" є undefined або generic
            errorMessage += ` <br>Можливі причини:
            <ul>
                <li>Браузер або операційна система відмовили в доступі до камери (перевірте дозволи для цього сайту).</li>
                <li>Ви використовуєте HTTP замість HTTPS (багато браузерів блокують доступ до камери для незахищених з'єднань).</li>
                <li>Файл 'assets/targets/targets.mind' не знайдено, пошкоджений або має неправильний шлях.</li>
                <li>Інша програма вже використовує вашу камеру.</li>
            </ul>`;
        }
        showMessage("Помилка AR:", errorMessage + "<br>Ви все одно побачите 3D-модель Сатурна, що обертається.");
      }

      webGLRenderer.setAnimationLoop(() => {
        // Анімувати обертання групи Сатурна
        saturnGroup.rotation.y += 0.005;

        // Рендерити як WebGL, так і CSS3D сцени
        webGLRenderer.render(scene, camera);
        cssRenderer.render(scene, camera);
      });
    }

    // Переконайтеся, що AR-досвід починається після повного завантаження вікна
    window.onload = function () {
        startAR();
    };
  </script>
</body>
</html>
