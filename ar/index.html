<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>AR Сатурн на Three.js з MindAR</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: black;
    }
    canvas {
      display: block;
      width: 100vw;
      height: 100vh;
    }
    #start-ar {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px;
      font-size: 18px;
      z-index: 10;
      background-color: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<!-- Start Button -->
<button id="start-ar">Start AR</button>

<!-- Load MindAR first -->
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-three.prod.js"></script> 

<!-- Your module code -->
<script type="module">

  import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js'; 

  let scene, camera, renderer;
  let saturnGroup;

  // Utility to wait for MINDAR to load
  function waitForMindAR() {
    return new Promise((resolve) => {
      const interval = setInterval(() => {
        if (window.MINDAR?.IMAGE?.MindARThree) {
          clearInterval(interval);
          resolve();
        }
      }, 100);
    });
  }

  async function init() {

    // Wait for library to load
    await waitForMindAR();

    // Initialize AR viewer
    const mindArViewer = new window.MINDAR.IMAGE.MindARThree({
      container: document.body,
      imageTargetSrc: 'assets/targets/targets.mind', // Make sure this path is correct
      uiScanning: false,
    });

    ({ scene, camera, renderer } = mindArViewer);

    // Lighting
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
    directionalLight.position.set(0, 1, 1);
    scene.add(directionalLight);

    // Saturn setup
    saturnGroup = new THREE.Group();

    const loader = new THREE.TextureLoader();

    // Saturn texture
    const satTex = loader.load('assets/textures/saturn.jpg');
    const satMat = new THREE.MeshStandardMaterial({ map: satTex, metalness: 0.2, roughness: 0.9 });
    const satGeo = new THREE.SphereGeometry(2, 64, 64);
    const satMesh = new THREE.Mesh(satGeo, satMat);
    satMesh.castShadow = true;
    satMesh.receiveShadow = true;

    // Ring texture
    const ringTex = loader.load('assets/textures/rings.jpg');
    const ringMat = new THREE.MeshStandardMaterial({
      map: ringTex,
      side: THREE.DoubleSide,
      transparent: true,
      alphaTest: 0.5
    });
    const ringGeo = new THREE.RingGeometry(2.5, 4.5, 256);
    const ringMesh = new THREE.Mesh(ringGeo, ringMat);
    ringMesh.rotation.x = -Math.PI / 2;

    // Add to group
    saturnGroup.add(satMesh);
    saturnGroup.add(ringMesh);
    saturnGroup.rotation.set(
      THREE.MathUtils.degToRad(-27),
      THREE.MathUtils.degToRad(120),
      0
    );

    // Attach to anchor
    const anchor = mindArViewer.addAnchor(0);
    anchor.group.add(saturnGroup);

    // Start AR after user click
    document.getElementById("start-ar").addEventListener("click", async () => {
      document.getElementById("start-ar").style.display = "none";
      await mindArViewer.start();
    });

    // Handle resize
    window.addEventListener('resize', () => {
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  }

  function animate() {
    requestAnimationFrame(animate);

    if (saturnGroup) {
      saturnGroup.rotation.y += 0.005;
    }

    if (renderer && scene && camera) {
      renderer.render(scene, camera);
    }
  }

  // Run in sequence
  init().then(() => {
    animate();
  });

</script>
</body>
</html>
